<!DOCTYPE html>
<!-- K.Agnew
    Feb 2019 -->
<head>
    <title>Opal Patient Reports</title>
    <meta charset="UTF-8">

    <!-- Libraries -->
    <!--<script src="./library/angular_1.6.6/angular.js"></script>
    <script src="./library/angular_1.6.6/angular-aria.min.js"></script>
    <script src="./library/angular-material_1.1.9/angular-material.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.6/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.6/angular-aria.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-material/1.1.9/angular-material.min.js"></script>

    <!-- Controllers -->
    <script type="text/javascript" src="Scripts/myApp.js"></script>
    <script type="text/javascript" src="Scripts/Ctrl1.js"></script>
    <script type="text/javascript" src="Scripts/Ctrl2.js"></script>
    <!-- Services -->
    <script src="install/Plotly/plotly-latest.min.js"></script>



    <!--<link rel="stylesheet" type="text/css" href="main.css">-->
    <style>
        body {
            background-color: linen;
        }

        table {
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

            th:hover {
                cursor: pointer;
            }

        tr:nth-child(even) {
            background-color: #dddddd;
        }

        .entryTable {
            border: 3px solid red;
            width: 50%;
            float: left;
        }

        .expTable {
            border: 1px solid tomato;
        }

        .showPatient {
            border: 3px solid green;
            width: 40%;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: palegreen;
        }

            .tab button {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 14px 16px;
                font-size: 17px;
            }

                .tab button:hover {
                    background-color: #ddd;
                }

                .tab button.active {
                    opacity: 0.8;
                }

        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: thick dotted palegreen;
            border-top: none;
        }
    </style>
</head>


<body ng-app="myApp">
    <center>
        <h1>Generate Opal Reports</h1>
    </center>
    <div id="tab" class="tab">
        <button class="tablinks" onclick="openTab(event, 'PatientReport')">Patient Reports</button>
        <button class="tablinks" onclick="openTab(event, 'GroupReport')">Group Reports</button>
    </div>
    <div id="PatientReport" class="tabcontent">
        <div ng-controller="Ctrl1" style="margin:5px;">
            <div>
                <div style="float:right;">
                    <p>
                        Database: <br />
                        <label style="color:darkgreen; font-weight:bold;"><input type="checkbox" ng-model="db.prod" ng-change="db.preprod = false; updateColours();"> Prod </label>
                        <br>
                        <label style="color:darkturquoise; font-weight:bold;"><input type="checkbox" ng-model="db.preprod" ng-change="db.prod = false; updateColours();"> Preprod </label>
                    </p>
                </div>
                <p style="float:left;">Enter patient last name or serial number or MRN or email or RAMQ. </p>

                <form ng-submit="findPat()">
                    <table>
                        <tr>
                            <td>Patient Last Name: <input type="text" ng-model="searchName" ng-disabled="searchSerial || patientMRN || patientEmail || patientRAMQ" ng-change="searchName==''?resetFieldValues():''"></td>
                            <td>Patient Serial Number: <input type="text" ng-model="searchSerial" ng-disabled="searchName || patientMRN || patientEmail || patientRAMQ" ng-change="searchSerial==''?resetFieldValues():''"></td>
                        </tr>
                        <tr>
                            <td>Patient MRN: <input type="text" ng-model="patientMRN" ng-disabled="searchName || searchSerial || patientEmail || patientRAMQ" ng-change="patientMRN==''?resetFieldValues():''"></td>
                            <td>Patient RAMQ: <input type="text" ng-model="patientRAMQ" ng-disabled="searchName || searchSerial || patientMRN || patientEmail" ng-change="patientRAMQ==''?resetFieldValues():''"></td>

                        </tr>
                        <tr>
                            <td>Patient Email: <input type="text" ng-model="patientEmail" ng-disabled="searchName || searchSerial || patientMRN || patientRAMQ" ng-change="patientEmail==''?resetFieldValues():''"></td>
                        </tr>
                        <tr>
                            <td colspan=5 align="center">
                                <input class="btn" value="Submit" type="submit">
                                <input class="btn" value="Reset" type="reset" ng-click="resetFieldValues()">
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
            <div ng-show="selectPatient">
                <select ng-model="selectedName" ng-options="x for x in patoptions"
                        ng-change="displaySelection()"></select>
            </div>

            <div ng-show="foundPatient">
                <form ng-submit="fetchData()">
                    <table class="entryTable">
                        <caption style="font-weight:bold; font-size:1.5em;">Selected Information</caption>
                        <tr>
                            <td><label>Diagnosis <input type="checkbox" ng-model="featureList.diagnosis"> </label></td>
                            <td><label>Appointments <input type="checkbox" ng-model="featureList.appointments"> </label></td>
                        </tr>
                        <tr>
                            <td><label>Questionnaires <input type="checkbox" ng-model="featureList.questionnaires"> </label></td>
                            <td><label>Educational Materials <input type="checkbox" ng-model="featureList.education"> </label></td>
                        </tr>
                        <tr>
                            <td><label>Lab Results <input type="checkbox" ng-model="featureList.testresults"> </label></td>
                            <td><label>Notifications <input type="checkbox" ng-model="featureList.notifications"></label></td>
                        </tr>
                        <tr>
                            <td><label>Treatment Planning <input type="checkbox" ng-model="featureList.treatplan"> </label></td>
                            <td><label>Clinical Notes <input type="checkbox" ng-model="featureList.clinicalnotes"></label></td>
                        </tr>
                        <tr>
                            <td><label>My Treating Team<input type="checkbox" ng-model="featureList.treatingteam"> </label></td>
                            <td><label>General Announcements <input type="checkbox" ng-model="featureList.general"></label></td>
                        </tr>
                        <tr>
                            <td colspan=5 align="center">
                                <input class="btn" value="Generate Report" type="submit" style="padding: 4px 4px 4px 4px; color:blue; font-weight: bold;">
                            </td>
                        </tr>
                    </table>
                    <br />
                </form>
                <div>
                    <table class="showPatient" style="margin-top:-17px;">
                        <caption style="font-weight:bold; font-size:1.5em;">Selected Patient</caption>
                        <tr>
                            <td> <b>Last Name</b> </td>
                            <td> {{pname}} </td>
                        </tr>
                        <tr>
                            <td> <b>First Name</b> </td>
                            <td> {{pfname}} </td>
                        </tr>
                        <tr>
                            <td> <b>Sex</b> </td>
                            <td> {{psex}} </td>
                        </tr>
                        <tr>
                            <td> <b>Patient Serial</b> </td>
                            <td> {{psnum}} </td>
                        </tr>
                        <tr>
                            <td><b>Email</b></td>
                            <td> {{pemail}}</td>
                        </tr>
                        <tr>
                            <td><b>RAMQ</b></td>
                            <td> {{pramq}}</td>
                        </tr>
                        <tr>
                            <td><b>MRN</b></td>
                            <td> {{pmrn}}</td>
                        </tr>
                        <tr>
                            <td><b>Opal App Language</b></td>
                            <td> {{planguage}}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <br><br>
            <div ng-show="foundPatient" style="clear:both;">
                <p><b>Note:</b> A special sorting function was implemented for the especially large tables (Appointments, Test Results, Notifications). This sorting function sorts only in one direction, whereas the slower sorting function implemented on the other tables can sort in the both directions (just click the table header again to reverse the sort)</p>
            </div>
            <div ng-show="featureList.diagnosis" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Diagnosis</h3>
                </center>
                <table id="diagTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'diagTable')">Date Created</th>
                        <th onclick="sortTable(1,'diagTable')">Diagnosis Description</th>
                        <th onclick="sortTable(2,'diagTable')">Diagnosis SerNum</th>
                    </tr>
                    <tr ng-repeat="x in diagReport | orderBy:'-created'">
                        <td> {{ x.created }} </td>
                        <td> {{ x.desc }} </td>
                        <td> {{ x.dsnum }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.appointments" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Appointments</h3>
                </center>
                <table id="apptTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'apptTable')">Date Created</th>
                        <th onclick="quickSortTrampoline(1,'apptTable')">Scheduled Start Time</th>
                        <th onclick="quickSortTrampoline(2,'apptTable')">Appointment Status</th>
                        <th onclick="quickSortTrampoline(3,'apptTable')">Appoint. Type</th>
                        <th onclick="quickSortTrampoline(4,'apptTable')">Appoint. Description</th>
                        <th onclick="quickSortTrampoline(5,'apptTable')">Resource Name</th>
                    </tr>
                    <tr ng-repeat="x in apptReport[0] | orderBy:'-starttime'">
                        <td> {{ x.created }} </td>
                        <td> {{ x.starttime }} </td>
                        <td> {{ x.status }} </td>
                        <td> {{ x.aptType }} </td>
                        <td> {{ x.aptDesc }} </td>
                        <td> {{ x.resName }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.questionnaires" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Questionnaires</h3>
                </center>
                <table id="qstTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'qstTable')">Date Sent</th>
                        <th onclick="sortTable(1,'qstTable')">Date Completed</th>
                        <th onclick="sortTable(2,'qstTable')">Questionnaire Name</th>
                    </tr>
                    <tr ng-repeat="y in qstReport[0] | orderBy:'-dateAdd'">
                        <td> {{ y.dateAdd }} </td>
                        <td> {{ y.dateComplete }} </td>
                        <td> {{ y.name }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.education" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Educational Materials</h3>
                </center>
                <table id="educTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'educTable')">Date Sent</th>
                        <th onclick="sortTable(1,'educTable')">Material Type</th>
                        <th onclick="sortTable(2,'educTable')">Material Name</th>
                        <th onclick="sortTable(3,'educTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in educReport[0] | orderBy:'-dateAdd'">
                        <td> {{ x.dateAdd }} </td>
                        <td> {{ x.matType }} </td>
                        <td> {{ x.matName }} </td>
                        <td> {{ x.readStatus }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.testresults" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Test Results</h3>
                </center>
                <table id="resTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'resTable')">Date Sent</th>
                        <th onclick="quickSortTrampoline(1,'resTable')">Date of Test</th>
                        <th onclick="quickSortTrampoline(2,'resTable')">Component Name</th>
                        <th onclick="quickSortTrampoline(3,'resTable')">Abnormal Flag</th>
                        <th onclick="quickSortTrampoline(4,'resTable')">Test Result</th>
                        <th onclick="quickSortTrampoline(5,'resTable')">Normal Range</th>
                        <th onclick="quickSortTrampoline(6,'resTable')">Unit Description</th>
                        <th onclick="quickSortTrampoline(7,'resTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in testReport[0] | orderBy:'-dateAdd'">
                        <td>{{ x.dateAdd }}</td>
                        <td>{{ x.dateTest }}</td>
                        <td>{{ x.compName }}</td>
                        <td>{{ x.flag }}</td>
                        <td>{{ x.testValue}}</td>
                        <td>{{ x.minNorm }} - {{ x.maxNorm }}</td>
                        <td>{{ x.unitDescription}}</td>
                        <td>{{ x.readStatus}}</td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.notifications" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Notifications</h3>
                </center>
                <table id="noteTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'noteTable')">Date Note Sent</th>
                        <th onclick="quickSortTrampoline(1,'noteTable')">Date Note Read</td>
                        <th onclick="quickSortTrampoline(2,'noteTable')">Note Header</td>
                        <th onclick="quickSortTrampoline(3,'noteTable')">Note Content</td>
                    </tr>
                    <tr ng-repeat="x in noteReport[0] | orderBy:'-dateadd'">
                        <td>{{ x.dateadd }}</td>
                        <td>{{ x.dateread }}</td>
                        <td>{{ x.notetype }}</td>
                        <td>{{ x.notedesc }}</td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.treatplan" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Treatment Planning</h3>
                </center>
                <table id="tplanTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'tplanTable')">Diagnosis</th>
                        <th onclick="sortTable(1, 'tplanTable')">Planning Stage</th>
                        <th onclick="sortTable(2, 'tplanTable')">Planning Stage Description</th>
                        <th onclick="sortTable(3, 'tplanTable')">Status</th>
                        <th onclick="sortTable(4, 'tplanTable')">State</th>
                        <th onclick="sortTable(5, 'tplanTable')">Due Date</th>
                        <th onclick="sortTable(6, 'tplanTable')">Completion Date</th>

                    </tr>
                    <tr ng-repeat="x in txplanReport[0] | orderBy:'duedate'">
                        <td> {{ x.diagdesc }} </td>
                        <td> {{ x.aliasname }} </td>
                        <td> {{ x.aliasdescription }} </td>
                        <td> {{ x.status }} </td>
                        <td> {{ x.state }} </td>
                        <td> {{ x.duedate }} </td>
                        <td> {{ x.completiondate }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.clinicalnotes" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Clinical Notes</h3>
                </center>
                <table id="clinTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'clinTable')">Date Created</th>
                        <th onclick="sortTable(1, 'clinTable')">Date Approved</th>
                        <th onclick="sortTable(2, 'clinTable')">Original File Name</th>
                        <th onclick="sortTable(3, 'clinTable')">Final File Name</th>
                        <th onclick="sortTable(4, 'clinTable')">Note Description</th>
                    </tr>
                    <tr ng-repeat="x in clinnoteReport[0] | orderBy:'-ctimestamp'">
                        <td> {{ x.ctimestamp }} </td>
                        <td> {{ x.atimestamp }} </td>
                        <td> {{ x.ofilename }} </td>
                        <td> {{ x.ffilename }} </td>
                        <td> {{ x.desc }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.treatingteam" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Treatment Team Messages</h3>
                </center>
                <table id="txmesTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'txmesTable')">Date Added</th>
                        <th onclick="sortTable(1, 'txmesTable')">Message Header</th>
                        <th onclick="sortTable(2, 'txmesTable')">Message Body</th>
                        <th onclick="sortTable(3, 'txmesTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in txteamReport[0] | orderBy:'-dateadded'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.postname }} </td>
                        <td> {{ x.postbody }} </td>
                        <td> {{ x.readstatus }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.general" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>General Announcements</h3>
                </center>
                <table id="genannTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'genannTable')">Date Added</th>
                        <th onclick="sortTable(1, 'genannTable')">Message Header</th>
                        <th onclick="sortTable(2, 'genannTable')">Message Body</th>
                        <th onclick="sortTable(3, 'genannTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in generalReport[0] | orderBy:'-dateadded'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.postname }} </td>
                        <td> {{ x.postbody }} </td>
                        <td> {{ x.readstatus }} </td>
                    </tr>
                </table>
            </div>
            <!--	<table id="testingTable">
                    <tr>
                        <th onclick="quickSortTrampoline(0, 'testingTable')">Test Header 1</th>
                        <th onclick="quickSortTrampoline(1, 'testingTable')">Test Header 2</th>
                        <th onclick="quickSortTrampoline(2, 'testingTable')">Test Header 3</th>
                    </tr>
                    <tr ng-repeat="x in testArray">
                        <td>{{ x.prop1 }}</td>
                        <td>{{ x.prop2 }}</td>
                        <td>{{ x.prop3 }}</td>
                    </tr>
                </table> -->
        </div>
    </div>

    <div id="GroupReport" class="tabcontent">
        <div ng-controller="Ctrl2" style="margin:5px">

            <div style="float:right; clear:both;">
                <p>
                    Database: <br />
                    <label style="color:darkgreen; font-weight:bold;"><input type="checkbox" ng-model="db.prod" ng-change="db.preprod = false; updateColours();"> Prod </label>
                    <br>
                    <label style="color:darkturquoise; font-weight:bold;"><input type="checkbox" ng-model="db.preprod" ng-change="db.prod = false; updateColours();"> Preprod </label>
                </p>
            </div>
            <p> Select group reporting category </p>
            <label><input type="checkbox" ng-model="category.education" ng-change="category.questionnaire = false; category.demographics = false; varStatus();"> Educational Material </label>
            <br>
            <label><input type="checkbox" ng-model="category.questionnaire" ng-change="category.education = false; category.demographics = false; getQuestionnaireOptions();"> Questionnaires </label>
            <br>
            <label><input type="checkbox" ng-model="category.demographics" ng-change="category.education = false; category.questionnaire = false; getPatientList();"> Demographics </label>
            <br>

            <div ng-show="category.education" style="border:1px solid black;">
                <center>
                    <h2> Educational Material Group Reporting </h2>
                </center>

                <label>
                    Educational material type:
                    <select ng-model="materialType" ng-options="x for x in materialTypes"
                            ng-change="getEducationalMaterialOptions()"></select>
                </label>

                <br>
                <label ng-show="displayMaterialList">
                    All {{materialType}} currently found in OpalDB: <select ng-model="selectedMaterial" ng-options="x for x in educList" ng-change="genEducReport(); showEducReport = true;"></select>
                </label>
                <div ng-show="showEducReport">
                    <div style="border: 1px solid blue; width: 70%;">
                        <h3 style="color:blue;"> &nbsp &nbsp Statistics for this report </h3>
                        <table style="padding: 5px 5px 5px 5px;">
                            <tr>
                                <td style="font-weight:bold;">% Female/Male</td>
                                <td>{{educFemPcnt}}% female; {{educMalPcnt}}% male; {{educUnkPcnt}}% unknown</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Average patient age (in this report)</td>
                                <td>{{educAvgAge}} years</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">% Materials Read</td>
                                <td>{{educReadPcnt}}% completed</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Average time until reading</td>
                                <td>{{educAvgDaysToRead}} days</td>
                            </tr>
                        </table>
                    </div>
                    <h3> &nbsp &nbsp Full report on {{materialType}}: {{selectedMaterial}}, {{educReportLength}} records found</h3>
                    <table id="groupEducTable">
                        <tr style="font-weight:bold;">
                            <th onclick="sortTable(0,'groupEducTable')">First Name</th>
                            <th onclick="sortTable(1,'groupEducTable')">Last Name</th>
                            <th onclick="sortTable(2,'groupEducTable')">Patient Ser Num</td>
                            <th onclick="sortTable(3,'groupEducTable')">Patient Sex</th>
                            <th onclick="sortTable(4,'groupEducTable')">Patient Age</th>
                            <th onclick="sortTable(5,'groupEducTable')">Patient Date of Birth</th>
                            <th onclick="sortTable(6,'groupEducTable')">Date Material Sent</th>
                            <th onclick="sortTable(7,'groupEducTable')">Read Status</th>
                        </tr>
                        <tr ng-repeat="x in educReport | orderBy:'lname'">
                            <td>{{ x.fname }}</td>
                            <td>{{ x.lname }}</td>
                            <td>{{ x.pser }}</td>
                            <td>{{ x.psex }}</td>
                            <td>{{ x.page }}</td>
                            <td>{{ x.pdob }}</td>
                            <td>{{ x.datesent }}</td>
                            <td>{{ x.readflag }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div ng-show="category.questionnaire" style="border:1px solid black;">
                <center>
                    <h2> Questionnaire Group Reporting </h2>
                </center>
                <label>
                    Choose questionnaire:
                    <select ng-model="selectedQuestionnaire" ng-options="x for x in qstOptions"
                            ng-change="genQstReport(); showQstReport = true;"></select>
                </label>

                <div ng-show="showQstReport">
                    <center>
                        <h3> Report on {{selectedQuestionnaire}}, {{qstReportLength}} total records found</h3>
                    </center>
                    <div style="border: 1px solid blue; width: 70%;">
                        <h3 style="color:blue;"> &nbsp &nbsp Statistics for this report </h3>
                        <table style="padding: 5px 5px 5px 5px;">
                            <tr>
                                <td style="font-weight:bold;">% Female/Male</td>
                                <td>{{pcntFemale}}% female; {{pcntMale}}% male; {{pcntUnk}}% unknown</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Total # unique patients in report</td>
                                <td>{{numUniquePats}} unique patients</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Average patient age (in this report)</td>
                                <td>{{avgPatAge}} years</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Total % completed questionnaires</td>
                                <td>{{pcntCompleted}}% completed</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Average completion time (among completed questionnaires)</td>
                                <td>{{avgCompletionTime}} days</td>
                            </tr>
                        </table>


                    </div>
                    <br><br>
                    <h3> &nbsp &nbsp Full Group Report:</h3>
                    <table id="groupQstTable">
                        <tr style="font-weight:bold;">
                            <th onclick="sortTable(0,'groupQstTable')">First Name</th>
                            <th onclick="sortTable(1,'groupQstTable')">Last Name</th>
                            <th onclick="sortTable(2,'groupQstTable')">Patient Ser Num</td>
                            <th onclick="sortTable(3,'groupQstTable')">Patient Sex</th>
                            <th onclick="sortTable(4,'groupQstTable')">Patient Date of Birth</th>
                            <th onclick="sortTable(5,'groupQstTable')">Date Material Sent</th>
                            <th onclick="sortTable(6,'groupQstTable')">Date Material Completed</th>
                        </tr>
                        <tr ng-repeat="x in qstReport | orderBy:'lname'">
                            <td>{{ x.fname }}</td>
                            <td>{{ x.lname }}</td>
                            <td>{{ x.pser }}</td>
                            <td>{{ x.psex }}</td>
                            <td>{{ x.pdob }}</td>
                            <td>{{ x.datesent }}</td>
                            <td>{{ x.datecomplete }}</td>
                        </tr>
                    </table>

                </div>
            </div>
            <div ng-show="category.demographics" style="border:3px solid black;">
                <center>
                    <h2> Demographics Group Reporting </h2>
                </center>
                <div style="border: 2px solid blue; width: 100%;">
                    <h3 style="color:blue;"> &nbsp &nbsp Statistics for this report </h3>
                    <table style="padding: 5px 5px 5px 5px;">
                        <tr>
                            <td style="font-weight:bold;">% Female/Male</td>
                            <td>{{demopcntFemale}}% female; {{demopcntMale}}% male; {{demopcntUnk}}% unknown</td>
                        </tr>
                        <tr>
                            <td style="font-weight:bold;">Average Patient Age</td>
                            <td>{{demoavgPatAge}} years</td>
                        </tr>
                        <tr>
                            <td style="font-weight:bold;">% French/English Preferred</td>
                            <td>{{demopcntFrench}}% french preferred; {{demopcntEnglish}}% english preferred;</td>
                        </tr>
                        <tr>
                            <td style="font-weight:bold;">List of <span style="color:red;">consent form expirations</span>, and upcoming expirations (&lt 3 monthes)</td>
                            <td>
                                <table class="expTable" id="consentTable">
                                    <thead>
                                        <tr>
                                            <th>First name</th>
                                            <th>Last name</th>
                                            <th>Date of expiration</th>
                                        </tr>
                                    </thead>
                                </table>
                            </td>
                        </tr>
                    </table>
                    <!--Plotting divisions for some stats visualizations-->
                    <div id="plotDiv1" style="width: 80%; float:left;">
                    </div>
                    <div id="plotDiv2" style="width: 100%; clear:both;">
                    </div>
                </div>
                <h3 style="clear:both;">&nbsp &nbsp Full Patient Information List, {{patientListLength}} total patients</h3>
                <table id="groupPatientTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'groupPatientTable')">First Name</th>
                        <th onclick="sortTable(1,'groupPatientTable')">Last Name</th>
                        <th onclick="sortTable(2,'groupPatientTable')">Patient Ser Num</td>
                        <th onclick="sortTable(3,'groupPatientTable')">Patient Sex</th>
                        <th onclick="sortTable(4,'groupPatientTable')">Patient Date of Birth</th>
                        <th onclick="sortTable(5,'groupPatientTable')">Patient Age</th>
                        <th onclick="sortTable(6,'groupPatientTable')">Patient Registration Date</th>
                        <th onclick="sortTable(7,'groupPatientTable')">Patient Preferred Language</th>
                        <th onclick="sortTable(8,'groupPatientTable')">Patient Consent Form Expiration</th>
                        <th onclick="sortTable(9, 'groupPatientTable')">Patient Diagnosis</th>
                        <th onclick="sortTable(10, 'groupPatientTable')">Diagnosis Date</th>
                    </tr>
                    <tr ng-repeat="x in patientList | orderBy:'lname'">
                        <td>{{ x.fname }}</td>
                        <td>{{ x.lname }}</td>
                        <td>{{ x.pser }}</td>
                        <td>{{ x.psex }}</td>
                        <td>{{ x.pdob }}</td>
                        <td>{{ x.age }}</td>
                        <td>{{ x.regdate }}</td>
                        <td>{{ x.lang }}</td>
                        <td>{{ x.consentexp }}</td>
                        <td>{{ x.diagdesc }}</td>
                        <td>{{ x.diagdate }}</td>
                    </tr>
                </table>

            </div>
        </div>
    </div>



    <script>
        //Control for the tabs at the top of the page
        function openTab(evt, tname) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tname).style.display = "block";
            evt.currentTarget.className += " active";
        }

        //This is necessary to define the beginning points of the recursive quickSort function (hi and lo)
        function quickSortTrampoline(n, tname) {
            var temptable = document.getElementById(tname);
            var lo = 1;
            var hi = temptable.rows.length - 1;
            quickSort(n, tname, lo, hi);
        }

        /**
        *	Quicksort - pick one element as a pivot, partition the array about this
        *				pivot; apply this operation recursively until sorted.

            tname - the id of the html table
            n 	  - the index of the column to sort by
            lo 	  - starting index
            hi 	  - ending index
        */
        function quickSort(n, tname, lo, hi) {
            var table = document.getElementById(tname);
            if (lo < hi) {
                //define the partioning index. table[pi] is now at the right place
                var pi = partition(n, tname, lo, hi);
                //recursive calls on quicksort to sort the two lists (before and after pi)
                quickSort(n, tname, lo, pi - 1);
                quickSort(n, tname, pi + 1, hi);
            }
        }
        //Partioning function for quickSort
        /**
            Take the last element as the pivot. Place pivot element at its correct
                position in the table. Then place all elements < pivot to the left of the pivot, and all greater elements to the right.
        */
        function partition(n, tname, lo, hi) {
            var table = document.getElementById(tname);
            var rows = table.rows;
            var pivot = rows[hi].getElementsByTagName("TD")[n]; //last element is pivot
            var i = (lo - 1); //index of the smaller element
            for (var j = lo; j <= hi - 1; j++) {
                //If current element is smaller than pivot, move index of the smaller element
                if (rows[j].getElementsByTagName("TD")[n].innerText >= pivot.innerText) {
                    i++;
                    //swap rows[i] with rows[j]
                    swap(tname, i, j);
                }
            }
            var temp = i + 1; //increment the partioning index
            swap(tname, temp, hi);
            return temp; //Return an incremented i index
        }
        //Swap two rows in a table given the indices
        function swap(tname, i, j) {
            var table = document.getElementById(tname);
            var rows = table.rows;
            if (i === j) { //Dont bother swapping the same row (Slightly improved performance)
                return;
            }
            if (i > j) { //Always keep the lower index as the first swap
                var temp = i;
                i = j;
                j = temp;
            }
            //swap i and j
            rows[i].parentNode.insertBefore(rows[j], rows[i]);
            rows[j].parentNode.insertBefore(rows[i + 1], rows[j].nextSibling);
        }

        /**
        *	This is the slow sorting function, analagous to a bubble sort, so O(n^2)
        *	We would like to improve the speed by switching to a quicksort/mergesort
        */
        function sortTable(n, tname) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById(tname); //table handle to get the data
            switching = true; //switching variable identifies if we are done or not (begin with true)
            dir = "asc"; // sorting direction
            while (switching) { // outer loop, continue until we have no more switches possible
                switching = false;
                rows = table.rows; //get rows to be sorted
                for (i = 1; i < (rows.length - 1); i++) { //inner loop, just identifies if we are doing a switch or not
                    shouldSwitch = false; //doing a switch? false by default
                    x = rows[i].getElementsByTagName("TD")[n]; //x and y elements to compare
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (dir == "asc") {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                            shouldSwitch = true; //mark a switch to be done and exit this branch
                            break;
                        }
                    } else if (dir == "desc") {
                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                            shouldSwitch = true; //mark a switch to be done and exit this branch
                            break;
                        }
                    }
                } //end of the inner loop. Either we are at a pair of elements that need to be swapped, or we are at the end of the list and we are finished
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); //perform the swap
                    switching = true; //identify that, since we did a swap, we need to restart the inner loop, so dont exit the outer while loop
                    switchcount++;      // keep track of where we are
                } else {
                    /*If no switching has been done AND the direction is "asc",
                    set the direction to "desc" and run the while loop again.*/
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
        }
    </script>


</body>
</html>
