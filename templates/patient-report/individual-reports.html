<div class="modal-header">
    <div class="col-xs-12 col-md-6">
      <h2 class="modal-title">
        <span class="glyphicon glyphicon-pencil"></span> 
        Individual Patient Reports 
      </h2>
    </div>
</div>
<div class="modal-body">
    <div id="PatientReport">
        <div style=>
            <div>
                <table style="display: inline-block; margin: 5px 5px 5px 5px;">
                    <tr>
                        <td>
                            <h2>Search for patient:</h2>
                        </td>
                        <td>
                            
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <form ng-submit="findPat()">
                                <table>
                                    <tr>
                                        <td>Patient Last Name:</td><td><input type="text" ng-model="searchName" ng-disabled="searchMRN || searchRAMQ" ng-change="searchName==''?resetFieldValues():''"></td>
                                    </tr>
                                    <tr>
                                        <td>Patient RAMQ:</td><td><input type="text" ng-model="searchRAMQ" ng-disabled="searchName || searchMRN" ng-change="searchRAMQ==''?resetFieldValues():''"></td>
                                    </tr>
                                    <tr>
                                        <td>Patient MRN:</td><td><input type="text" ng-model="searchMRN" ng-disabled="searchName || searchRAMQ" ng-change="searchMRN==''?resetFieldValues():''"></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input class="btn" value="Submit" type="submit">
                                            <input class="btn" value="Reset" type="reset" ng-click="resetFieldValues()">
                                        </td>
                                    </tr>
                                </table>
                            </form>
                        </td>
                        <td style="float:right;">
                            <p>
                                Database: <br />
                                <label style="color:darkgreen; font-weight:bold;"><input type="checkbox" ng-model="db.prod" ng-change="db.preprod = false; updateColours();"> Prod </label>
                                <br>
                                <label style="color:darkturquoise; font-weight:bold;"><input type="checkbox" ng-model="db.preprod" ng-change="db.prod = false; updateColours();"> Preprod </label>
                            </p>

                        </td>
                    </tr>
                </table>
            </div>
            <br/>

            <div ng-show="selectPatient" style="display:inline-block;">
                <p>Multiple patients found matching search criteria, please select: </p>
                <select ng-model="selectedName" ng-options="x for x in patOptions"
                        ng-change="displaySelection()"></select>
            </div>

            <div ng-show="foundPatient">
                <form ng-submit="fetchData()">
                    <table class="entryTable">
                        <caption style="font-weight:bold; font-size:1.5em;">Selected Information</caption>
                        <tr>
                            <td><label>Diagnosis <input type="checkbox" ng-model="featureList.diagnosis"> </label></td>
                            <td><label>Appointments <input type="checkbox" ng-model="featureList.appointments"> </label></td>
                        </tr>
                        <tr>
                            <td><label>Questionnaires <input type="checkbox" ng-model="featureList.questionnaires"> </label></td>
                            <td><label>Educational Materials <input type="checkbox" ng-model="featureList.education"> </label></td>
                        </tr>
                        <tr>
                            <td><label>Lab Results <input type="checkbox" ng-model="featureList.testresults"> </label></td>
                            <td><label>Notifications <input type="checkbox" ng-model="featureList.notifications"></label></td>
                        </tr>
                        <tr>
                            <td><label>Treatment Planning <input type="checkbox" ng-model="featureList.treatplan"> </label></td>
                            <td><label>Clinical Notes <input type="checkbox" ng-model="featureList.clinicalnotes"></label></td>
                        </tr>
                        <tr>
                            <td><label>My Treating Team<input type="checkbox" ng-model="featureList.treatingteam"> </label></td>
                            <td><label>General Announcements <input type="checkbox" ng-model="featureList.general"></label></td>
                        </tr>
                        <tr>
                            <td>
                                <input class="btn" value="Generate Report" type="submit" style="padding: 4px 4px 4px 4px; color:blue; font-weight: bold;">
                            </td>
                        </tr>
                    </table>
                    <br />
                </form>
                <div>
                    <table class="showPatient">
                        <caption style="font-weight:bold; font-size:1.5em;">Selected Patient</caption>
                        <tr>
                            <td> <b>Last Name</b> </td>
                            <td> {{plname}} </td>
                        </tr>
                        <tr>
                            <td> <b>First Name</b> </td>
                            <td> {{pname}} </td>
                        </tr>
                        <tr>
                            <td> <b>Sex</b> </td>
                            <td> {{psex}} </td>
                        </tr>
                        <tr>
                            <td> <b>Patient Serial</b> </td>
                            <td> {{psnum}} </td>
                        </tr>
                        <tr>
                            <td><b>Email</b></td>
                            <td> {{pemail}}</td>
                        </tr>
                        <tr>
                            <td><b>RAMQ</b></td>
                            <td> {{pramq}}</td>
                        </tr>
                        <tr>
                            <td><b>MRN</b></td>
                            <td> {{pid}}</td>
                        </tr>
                        <tr>
                            <td><b>Opal App Language</b></td>
                            <td> {{plang}}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <br><br>
            <div ng-show="foundPatient" style="clear:both;">
                <p><b>Note:</b> A special sorting function was implemented for the especially large tables (Appointments, Test Results, Notifications). This sorting function sorts only in one direction, whereas the slower sorting function implemented on the other tables can sort in the both directions (just click the table header again to reverse the sort)</p>
            </div>
            <div ng-show="featureList.diagnosis" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Diagnosis</h3>
                </center>
                <table id="diagTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'diagTable')">Date Created</th>
                        <th onclick="sortTable(1,'diagTable')">Diagnosis Description</th>
                        <th onclick="sortTable(2,'diagTable')">Diagnosis SerNum</th>
                    </tr>
                    <tr ng-repeat="x in diagReport">
                        <td> {{ x.creationdate }} </td>
                        <td> {{ x.description }} </td>
                        <td> {{ x.sernum }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.appointments" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Appointments</h3>
                </center>
                <table id="apptTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'apptTable')">Date Created</th>
                        <th onclick="quickSortTrampoline(1,'apptTable')">Scheduled Start Time</th>
                        <th onclick="quickSortTrampoline(2,'apptTable')">Appointment Status</th>
                        <th onclick="quickSortTrampoline(3,'apptTable')">Appoint. Type</th>
                        <th onclick="quickSortTrampoline(4,'apptTable')">Appoint. Description</th>
                        <th onclick="quickSortTrampoline(5,'apptTable')">Resource Name</th>
                    </tr>
                    <tr ng-repeat="x in apptReport | orderBy:'-starttime'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.starttime }} </td>
                        <td> {{ x.status }} </td>
                        <td> {{ x.aliastype }} </td>
                        <td> {{ x.aliasname }} </td>
                        <td> {{ x.resourcename }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.questionnaires" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Questionnaires</h3>
                </center>
                <table id="qstTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'qstTable')">Date Sent</th>
                        <th onclick="sortTable(1,'qstTable')">Date Completed</th>
                        <th onclick="sortTable(2,'qstTable')">Questionnaire Name</th>
                    </tr>
                    <tr ng-repeat="y in qstReport | orderBy:'-dateadded'">
                        <td> {{ y.dateadded }} </td>
                        <td> {{ y.datecompleted }} </td>
                        <td> {{ y.name }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.education" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Educational Materials</h3>
                </center>
                <table id="educTable">
                    <tr style="font-weight:bold;">
                        <th onclick="sortTable(0,'educTable')">Date Sent</th>
                        <th onclick="sortTable(1,'educTable')">Material Type</th>
                        <th onclick="sortTable(2,'educTable')">Material Name</th>
                        <th onclick="sortTable(3,'educTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in educReport | orderBy:'-dateadded'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.materialtype }} </td>
                        <td> {{ x.name }} </td>
                        <td> {{ x.readstatus }} </td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.testresults" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Test Results</h3>
                </center>
                <table id="resTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'resTable')">Date Sent</th>
                        <th onclick="quickSortTrampoline(1,'resTable')">Date of Test</th>
                        <th onclick="quickSortTrampoline(2,'resTable')">Component Name</th>
                        <th onclick="quickSortTrampoline(3,'resTable')">Abnormal Flag</th>
                        <th onclick="quickSortTrampoline(4,'resTable')">Test Result</th>
                        <th onclick="quickSortTrampoline(5,'resTable')">Normal Range</th>
                        <th onclick="quickSortTrampoline(6,'resTable')">Unit Description</th>
                        <th onclick="quickSortTrampoline(7,'resTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in testReport | orderBy:'-dateadded'">
                        <td>{{ x.dateadded }}</td>
                        <td>{{ x.testdate }}</td>
                        <td>{{ x.componentname }}</td>
                        <td>{{ x.abnormalflag }}</td>
                        <td>{{ x.testvalue}}</td>
                        <td>{{ x.minnorm }} - {{ x.maxnorm }}</td>
                        <td>{{ x.unitdescription}}</td>
                        <td>{{ x.readstatus}}</td>
                    </tr>
                </table>
            </div>

            <div ng-show="featureList.notifications" style="border:1px solid black; clear:both;">
                <center>
                    <h3>Notifications</h3>
                </center>
                <table id="noteTable">
                    <tr style="font-weight:bold;">
                        <th onclick="quickSortTrampoline(0,'noteTable')">Date Note Sent</th>
                        <th onclick="quickSortTrampoline(1,'noteTable')">Date Note Read</td>
                        <th onclick="quickSortTrampoline(2,'noteTable')">Note Header</td>
                        <th onclick="quickSortTrampoline(3,'noteTable')">Note Content</td>
                    </tr>
                    <tr ng-repeat="x in noteReport | orderBy:'-dateadded'">
                        <td>{{ x.dateadded }}</td>
                        <td>{{ x.lastupdated }}</td>
                        <td>{{ x.tablerowtitle }}</td>
                        <td>{{ x.name }}</td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.treatplan" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Treatment Planning</h3>
                </center>
                <table id="tplanTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'tplanTable')">Diagnosis</th>
                        <th onclick="sortTable(1, 'tplanTable')">Planning Stage</th>
                        <th onclick="sortTable(2, 'tplanTable')">Planning Stage Description</th>
                        <th onclick="sortTable(3, 'tplanTable')">Status</th>
                        <th onclick="sortTable(4, 'tplanTable')">State</th>
                        <th onclick="sortTable(5, 'tplanTable')">Due Date</th>
                        <th onclick="sortTable(6, 'tplanTable')">Completion Date</th>

                    </tr>
                    <tr ng-repeat="x in txplanReport | orderBy:'taskdue'">
                        <td> {{ x.diagnosisdescription }} </td>
                        <td> {{ x.aliasname }} </td>
                        <td> {{ x.aliasdescription }} </td>
                        <td> {{ x.taskstatus }} </td>
                        <td> {{ x.taskstate }} </td>
                        <td> {{ x.taskdue }} </td>
                        <td> {{ x.taskcompletiondate }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.clinicalnotes" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Clinical Notes</h3>
                </center>
                <table id="clinTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'clinTable')">Date Created</th>
                        <th onclick="sortTable(1, 'clinTable')">Date Approved</th>
                        <th onclick="sortTable(2, 'clinTable')">Original File Name</th>
                        <th onclick="sortTable(3, 'clinTable')">Final File Name</th>
                        <th onclick="sortTable(4, 'clinTable')">Note Description</th>
                    </tr>
                    <tr ng-repeat="x in clinnoteReport | orderBy:'-created'">
                        <td> {{ x.created }} </td>
                        <td> {{ x.approved }} </td>
                        <td> {{ x.originalname }} </td>
                        <td> {{ x.finalname }} </td>
                        <td> {{ x.aliasexpressionname }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.treatingteam" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>Treatment Team Messages</h3>
                </center>
                <table id="txmesTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'txmesTable')">Date Added</th>
                        <th onclick="sortTable(1, 'txmesTable')">Message Header</th>
                        <th onclick="sortTable(2, 'txmesTable')">Message Body</th>
                        <th onclick="sortTable(3, 'txmesTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in txteamReport[0] | orderBy:'-dateadded'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.name }} </td>
                        <td> {{ x.body }} </td>
                        <td> {{ x.readstatus }} </td>
                    </tr>
                </table>
            </div>
            <div ng-show="featureList.general" style="border: 1px solid black; clear:both;">
                <center>
                    <h3>General Announcements</h3>
                </center>
                <table id="genannTable">
                    <tr style="font-weight: bold;">
                        <th onclick="sortTable(0, 'genannTable')">Date Added</th>
                        <th onclick="sortTable(1, 'genannTable')">Message Header</th>
                        <th onclick="sortTable(2, 'genannTable')">Message Body</th>
                        <th onclick="sortTable(3, 'genannTable')">Read Status</th>
                    </tr>
                    <tr ng-repeat="x in generalReport[0] | orderBy:'-dateadded'">
                        <td> {{ x.dateadded }} </td>
                        <td> {{ x.name }} </td>
                        <td> {{ x.body }} </td>
                        <td> {{ x.readstatus }} </td>
                    </tr>
                </table>
            </div>
            <!--	<table id="testingTable">
                    <tr>
                        <th onclick="quickSortTrampoline(0, 'testingTable')">Test Header 1</th>
                        <th onclick="quickSortTrampoline(1, 'testingTable')">Test Header 2</th>
                        <th onclick="quickSortTrampoline(2, 'testingTable')">Test Header 3</th>
                    </tr>
                    <tr ng-repeat="x in testArray">
                        <td>{{ x.prop1 }}</td>
                        <td>{{ x.prop2 }}</td>
                        <td>{{ x.prop3 }}</td>
                    </tr>
                </table> -->
        </div>
    </div>
</div>

<script>

    //This is necessary to define the beginning points of the recursive quickSort function (hi and lo)
    function quickSortTrampoline(n, tname) {
        var temptable = document.getElementById(tname);
        var lo = 1;
        var hi = temptable.rows.length - 1;
        quickSort(n, tname, lo, hi);
    }

    /**
    *	Quicksort - pick one element as a pivot, partition the array about this
    *				pivot; apply this operation recursively until sorted.

        tname - the id of the html table
        n 	  - the index of the column to sort by
        lo 	  - starting index
        hi 	  - ending index
    */
    function quickSort(n, tname, lo, hi) {
        var table = document.getElementById(tname);
        if (lo < hi) {
            //define the partioning index. table[pi] is now at the right place
            var pi = partition(n, tname, lo, hi);
            //recursive calls on quicksort to sort the two lists (before and after pi)
            quickSort(n, tname, lo, pi - 1);
            quickSort(n, tname, pi + 1, hi);
        }
    }
    //Partioning function for quickSort
    /**
        Take the last element as the pivot. Place pivot element at its correct
            position in the table. Then place all elements < pivot to the left of the pivot, and all greater elements to the right.
    */
    function partition(n, tname, lo, hi) {
        var table = document.getElementById(tname);
        var rows = table.rows;
        var pivot = rows[hi].getElementsByTagName("TD")[n]; //last element is pivot
        var i = (lo - 1); //index of the smaller element
        for (var j = lo; j <= hi - 1; j++) {
            //If current element is smaller than pivot, move index of the smaller element
            if (rows[j].getElementsByTagName("TD")[n].innerText >= pivot.innerText) {
                i++;
                //swap rows[i] with rows[j]
                swap(tname, i, j);
            }
        }
        var temp = i + 1; //increment the partioning index
        swap(tname, temp, hi);
        return temp; //Return an incremented i index
    }
    //Swap two rows in a table given the indices
    function swap(tname, i, j) {
        var table = document.getElementById(tname);
        var rows = table.rows;
        if (i === j) { //Dont bother swapping the same row (Slightly improved performance)
            return;
        }
        if (i > j) { //Always keep the lower index as the first swap
            var temp = i;
            i = j;
            j = temp;
        }
        //swap i and j
        rows[i].parentNode.insertBefore(rows[j], rows[i]);
        rows[j].parentNode.insertBefore(rows[i + 1], rows[j].nextSibling);
    }

    /**
    *	This is the slow sorting function, analagous to a bubble sort, so O(n^2)
    *	We would like to improve the speed by switching to a quicksort/mergesort
    */
    function sortTable(n, tname) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById(tname); //table handle to get the data
        switching = true; //switching variable identifies if we are done or not (begin with true)
        dir = "asc"; // sorting direction
        while (switching) { // outer loop, continue until we have no more switches possible
            switching = false;
            rows = table.rows; //get rows to be sorted
            for (i = 1; i < (rows.length - 1); i++) { //inner loop, just identifies if we are doing a switch or not
                shouldSwitch = false; //doing a switch? false by default
                x = rows[i].getElementsByTagName("TD")[n]; //x and y elements to compare
                y = rows[i + 1].getElementsByTagName("TD")[n];
                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true; //mark a switch to be done and exit this branch
                        break;
                    }
                } else if (dir == "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true; //mark a switch to be done and exit this branch
                        break;
                    }
                }
            } //end of the inner loop. Either we are at a pair of elements that need to be swapped, or we are at the end of the list and we are finished
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); //perform the swap
                switching = true; //identify that, since we did a swap, we need to restart the inner loop, so dont exit the outer while loop
                switchcount++;      // keep track of where we are
            } else {
                /*If no switching has been done AND the direction is "asc",
                set the direction to "desc" and run the while loop again.*/
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }
</script>

